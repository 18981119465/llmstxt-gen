# Story 1.5: 数据模型与数据库实现

## Status

**Status**: Approved

## Story

**As a** 后端开发者，  
**I want** 建立完整的数据模型和数据库实现，  
**so that** 为API服务提供可靠的数据存储和查询支持。

## Acceptance Criteria

1. 实现基于SQLAlchemy的ORM数据模型
2. 建立数据库连接和会话管理
3. 实现数据库迁移和版本管理
4. 配置数据库索引和性能优化
5. 实现数据验证和约束机制
6. 建立数据备份和恢复策略

## Tasks / Subtasks

- [ ] Task 1: 设计数据模型架构 (AC: 1)
  - [ ] 设计SQLAlchemy模型结构
  - [ ] 定义模型关系和约束
  - [ ] 实现数据验证规则
  - [ ] 设计模型继承和扩展机制

- [ ] Task 2: 实现核心数据模型 (AC: 1)
  - [ ] 实现用户模型和权限模型
  - [ ] 实现项目模型和配置模型
  - [ ] 实现文档模型和内容模型
  - [ ] 实现任务模型和状态模型
  - [ ] 实现系统配置模型

- [ ] Task 3: 建立数据库连接管理 (AC: 2)
  - [ ] 实现数据库连接池
  - [ ] 建立会话管理机制
  - [ ] 实现事务管理
  - [ ] 配置连接超时和重试
  - [ ] 实现连接健康检查

- [ ] Task 4: 实现数据库迁移管理 (AC: 3)
  - [ ] 配置Alembic迁移工具
  - [ ] 创建初始数据库架构
  - [ ] 实现迁移版本管理
  - [ ] 建立迁移回滚机制
  - [ ] 创建迁移脚本模板

- [ ] Task 5: 配置数据库性能优化 (AC: 4)
  - [ ] 实现数据库索引策略
  - [ ] 配置查询优化
  - [ ] 实现缓存策略
  - [ ] 建立查询监控
  - [ ] 实现性能调优

- [ ] Task 6: 实现数据验证和约束 (AC: 5)
  - [ ] 实现字段级验证
  - [ ] 建立模型级约束
  - [ ] 实现自定义验证器
  - [ ] 配置数据完整性检查
  - [ ] 实现验证错误处理

- [ ] Task 7: 建立数据备份和恢复 (AC: 6)
  - [ ] 实现自动备份策略
  - [ ] 配置备份存储管理
  - [ ] 实现数据恢复机制
  - [ ] 建立备份验证流程
  - [ ] 实现灾难恢复方案

- [ ] Task 8: 集成数据库到现有系统 (AC: 2, 4, 5)
  - [ ] 集成数据库到API框架
  - [ ] 集成数据库到监控系统
  - [ ] 集成数据库到配置管理
  - [ ] 实现数据库健康检查
  - [ ] 创建数据库管理工具

## Dev Notes

### Previous Story Insights
从故事1.4基础API服务框架中学习到的关键信息：
- 已建立FastAPI + Pydantic的API框架，需要与数据库模型集成 [Source: docs/stories/1.4.api-framework.story.md#132]
- 已实现JWT认证和RBAC授权，需要用户和权限数据模型支持 [Source: docs/stories/1.4.api-framework.story.md#196]
- 已建立统一响应格式，需要数据库查询结果标准化 [Source: docs/stories/1.4.api-framework.story.md#185]
- 已配置API限流和安全防护，需要数据库连接池管理 [Source: docs/stories/1.4.api-framework.story.md#51]

从故事1.3日志监控系统中学习到的关键信息：
- 已建立完整的日志和监控体系，可用于数据库性能监控 [Source: docs/stories/1.3.monitoring-logging.story.md#74]
- 已实现健康检查机制，可用于数据库连接健康检查 [Source: docs/stories/1.3.monitoring-logging.story.md#37]
- 已建立告警系统，可用于数据库异常告警 [Source: docs/stories/1.3.monitoring-logging.story.md#51]
- 需要考虑数据库操作的性能监控和日志记录 [Source: docs/stories/1.3.monitoring-logging.story.md#312]

从故事1.2配置管理系统中学习到的关键信息：
- 已建立完整的配置管理机制，可用于数据库配置管理 [Source: docs/stories/1.2.config-management.story.md#79]
- 已实现配置热重载功能，可用于数据库配置动态更新 [Source: docs/stories/1.2.config-management.story.md#36]
- 已创建配置管理API，可用于数据库配置管理 [Source: docs/stories/1.2.config-management.story.md#43]

### 系统架构设计
基于模块化单体架构设计，数据库模型需要支持多服务数据统一管理 [Source: docs/architecture/01-system-architecture.md#1.1]:

**数据库模型层次结构**:
```
database/
├── models/              # 数据模型
│   ├── base.py         # 基础模型
│   ├── user.py         # 用户模型
│   ├── project.py      # 项目模型
│   ├── document.py     # 文档模型
│   ├── task.py         # 任务模型
│   └── system.py       # 系统模型
├── schemas/            # Pydantic模式
│   ├── base.py         # 基础模式
│   ├── user.py         # 用户模式
│   ├── project.py      # 项目模式
│   ├── document.py     # 文档模式
│   └── response.py     # 响应模式
├── repositories/        # 数据仓库
│   ├── base.py         # 基础仓库
│   ├── user.py         # 用户仓库
│   ├── project.py      # 项目仓库
│   └── document.py     # 文档仓库
├── migrations/         # 数据库迁移
│   ├── versions/       # 迁移版本
│   └── alembic.ini     # Alembic配置
└── utils/              # 数据库工具
    ├── connection.py   # 连接管理
    ├── session.py      # 会话管理
    └── backup.py       # 备份工具
```

### 技术栈配置
基于技术栈文档选择合适的数据库技术 [Source: docs/architecture/02-tech-stack.md]:

**数据库技术栈**:
- **SQLAlchemy**: ORM框架
- **Alembic**: 数据库迁移工具
- **psycopg2**: PostgreSQL适配器
- **asyncpg**: 异步PostgreSQL驱动
- **Redis**: 缓存和会话存储
- **ChromaDB**: 向量数据库

**数据验证技术栈**:
- **Pydantic**: 数据验证和序列化
- **SQLAlchemy-Validation**: 模型验证
- **email-validator**: 邮箱验证
- **phonenumbers**: 电话号码验证

**数据库管理工具**:
- **pgAdmin**: 数据库管理界面
- **DBeaver**: 通用数据库工具
- **Redis CLI**: Redis命令行工具
- **Alembic CLI**: 迁移管理工具

### 数据模型设计
基于数据模型设计文档，需要实现完整的数据库模型 [Source: docs/architecture/03-data-model.md#32]:

**核心数据模型**:
```python
# 用户模型
class User(Base):
    __tablename__ = 'users'
    
    id = Column(UUID, primary_key=True, default=uuid.uuid4)
    username = Column(String(50), unique=True, nullable=False)
    email = Column(String(255), unique=True, nullable=False)
    password_hash = Column(String(255), nullable=False)
    role = Column(String(20), default='user')
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

# 项目模型
class Project(Base):
    __tablename__ = 'projects'
    
    id = Column(UUID, primary_key=True, default=uuid.uuid4)
    name = Column(String(255), nullable=False)
    description = Column(Text)
    owner_id = Column(UUID, ForeignKey('users.id'))
    config = Column(JSONB)
    status = Column(String(20), default='active')
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

# 文档模型
class Document(Base):
    __tablename__ = 'documents'
    
    id = Column(UUID, primary_key=True, default=uuid.uuid4)
    project_id = Column(UUID, ForeignKey('projects.id'))
    name = Column(String(255), nullable=False)
    type = Column(String(50), nullable=False)
    source_url = Column(Text)
    file_path = Column(String(500))
    file_size = Column(BigInteger)
    metadata = Column(JSONB)
    status = Column(String(20), default='pending')
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

# 任务模型
class Task(Base):
    __tablename__ = 'tasks'
    
    id = Column(UUID, primary_key=True, default=uuid.uuid4)
    task_type = Column(String(50), nullable=False)
    status = Column(String(20), default='pending')
    progress = Column(Integer, default=0)
    config = Column(JSONB)
    result = Column(JSONB)
    error_message = Column(Text)
    created_at = Column(DateTime, default=datetime.utcnow)
    completed_at = Column(DateTime)
```

### API架构集成
基于API架构设计文档，数据库模型需要与API框架集成 [Source: docs/architecture/04-api-architecture.md#4.1]:

**数据库集成要求**:
- **异步支持**: 支持FastAPI异步操作
- **会话管理**: 数据库会话生命周期管理
- **事务处理**: 支持数据库事务
- **连接池**: 高效的数据库连接管理
- **错误处理**: 数据库异常处理

**数据仓库模式**:
```python
# 基础仓库
class BaseRepository:
    def __init__(self, session: AsyncSession):
        self.session = session
    
    async def create(self, obj: Base) -> Base:
        self.session.add(obj)
        await self.session.commit()
        await self.session.refresh(obj)
        return obj
    
    async def get(self, id: UUID) -> Optional[Base]:
        result = await self.session.get(self.model, id)
        return result
    
    async def update(self, obj: Base) -> Base:
        await self.session.commit()
        await self.session.refresh(obj)
        return obj
    
    async def delete(self, obj: Base) -> None:
        await self.session.delete(obj)
        await self.session.commit()

# 用户仓库
class UserRepository(BaseRepository):
    model = User
    
    async def get_by_username(self, username: str) -> Optional[User]:
        result = await self.session.execute(
            select(User).where(User.username == username)
        )
        return result.scalar_one_or_none()
    
    async def get_by_email(self, email: str) -> Optional[User]:
        result = await self.session.execute(
            select(User).where(User.email == email)
        )
        return result.scalar_one_or_none()
```

### 安全架构考虑
基于安全架构设计，数据库需要考虑数据安全和访问控制 [Source: docs/architecture/05-security-architecture.md]:

**数据库安全要求**:
- **数据加密**: 敏感数据加密存储
- **访问控制**: 数据库访问权限控制
- **审计日志**: 数据库操作审计
- **备份安全**: 备份数据安全存储
- **连接安全**: 数据库连接加密

**数据加密策略**:
```python
# 密码加密
from bcrypt import hashpw, gensalt

def hash_password(password: str) -> str:
    salt = gensalt()
    hashed = hashpw(password.encode('utf-8'), salt)
    return hashed.decode('utf-8')

# 敏感数据加密
from cryptography.fernet import Fernet

def encrypt_data(data: str, key: str) -> str:
    f = Fernet(key.encode())
    encrypted = f.encrypt(data.encode())
    return encrypted.decode()

def decrypt_data(encrypted_data: str, key: str) -> str:
    f = Fernet(key.encode())
    decrypted = f.decrypt(encrypted_data.encode())
    return decrypted.decode()
```

### 文件位置和命名约定
基于故事1.1建立的项目结构 [Source: docs/stories/1.1.project-init-dev-env.story.md#212]:

**核心数据库文件**:
- `backend/src/database/` - 数据库模块目录
- `backend/src/database/models/` - 数据模型
- `backend/src/database/schemas/` - Pydantic模式
- `backend/src/database/repositories/` - 数据仓库
- `backend/src/database/migrations/` - 数据库迁移
- `backend/src/database/utils/` - 数据库工具

**数据库配置文件**:
- `config/database.yaml` - 数据库配置
- `config/alembic.ini` - Alembic配置
- `config/redis.yaml` - Redis配置

### Testing

**测试框架和标准** [Source: docs/architecture/07-monitoring-dev-standards.md#9.2]:
- pytest + pytest-asyncio (Python)
- 测试文件位置：tests/database/
- 测试覆盖率要求：90%+（数据库核心模块）

**测试要求**:
- 数据模型测试
- 数据仓库测试
- 数据库连接测试
- 迁移脚本测试
- 性能测试
- 安全测试

**测试场景**:
- 数据模型创建和验证
- 数据仓库CRUD操作
- 数据库连接和会话管理
- 数据库迁移和回滚
- 数据库性能和并发
- 数据库安全性和加密

**测试执行指令**:

```bash
# 单元测试
python -m pytest tests/database/test_models.py -v --cov=backend/src/database
python -m pytest tests/database/test_repositories.py -v --cov=backend/src/database
python -m pytest tests/database/test_connections.py -v --cov=backend/src/database

# 集成测试
python -m pytest tests/database/test_integration.py -v --cov=backend/src/database

# 迁移测试
python -m pytest tests/database/test_migrations.py -v --cov=backend/src/database

# 性能测试
python -m pytest tests/database/test_performance.py -v --benchmark-only

# 安全测试
python -m pytest tests/database/test_security.py -v --cov=backend/src/database

# 测试覆盖率报告
python -m pytest tests/database/ --cov=backend/src/database --cov-report=html --cov-report=term-missing

# 数据库专项测试
python scripts/database/test_database_operations.py --duration=300
```

**性能测试指标**:
- 数据库连接时间：< 100ms
- 查询响应时间：< 50ms（简单查询）
- 批量插入性能：> 1000条/秒
- 并发连接支持：≥ 100个并发连接
- 事务处理时间：< 200ms
- 内存使用增长：< 100MB（100并发）

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-07 | 1.0 | Initial story creation | Bob (Scrum Master) |